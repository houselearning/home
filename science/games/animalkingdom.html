<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Animal Kingdom Explorer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script> <!-- GLTFLoader added -->
    <style>
        body {
            margin: 0;
            overflow: hidden; /* Hide scrollbars */
            font-family: "Inter", sans-serif; /* Use Inter font */
            background-color: #1a202c; /* Dark background */
        }
        canvas {
            display: block;
            width: 100vw;
            height: 100vh;
        }
        #infoPanel {
            position: absolute;
            top: 20px;
            right: 20px;
            background-color: rgba(45, 55, 72, 0.9); /* Darker semi-transparent background */
            padding: 20px;
            border-radius: 12px; /* More rounded corners */
            color: #e2e8f0; /* Light text */
            max-width: 350px;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(74, 85, 104, 0.7); /* Subtle border */
            transform: translateX(calc(100% + 20px)); /* Start off-screen to the right */
            transition: transform 0.3s ease-out; /* Smooth slide-in effect */
        }
        #infoPanel.active {
            transform: translateX(0); /* Slide into view */
        }
        #infoPanel h2 {
            font-size: 1.8rem; /* Larger heading */
            font-weight: bold;
            margin-bottom: 10px;
            color: #63b3ed; /* Light blue for heading */
        }
        #infoPanel p {
            font-size: 1rem;
            line-height: 1.5;
            margin-bottom: 15px;
        }
        #animalVideo {
            width: 100%;
            height: auto;
            border-radius: 8px; /* Rounded video corners */
            margin-bottom: 15px;
            background-color: black; /* Background for video while loading */
        }
        #closeButton {
            background-color: #e53e3e; /* Red close button */
            color: white;
            padding: 8px 15px;
            border: none;
            border-radius: 8px; /* Rounded button */
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.2s ease-in-out;
        }
        #closeButton:hover {
            background-color: #c53030;
        }
        #loadingOverlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            z-index: 1000;
        }
        #loadingBar {
            width: 50%;
            height: 20px;
            background-color: #333;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 20px;
        }
        #loadingProgress {
            height: 100%;
            width: 0%;
            background-color: #63b3ed;
            border-radius: 10px;
            transition: width 0.1s linear;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 flex items-center justify-center min-h-screen">
    <h1>âš  BETA PREVIEW GAME: Do not create a issue on this game, as this current game is still in-development. This is just a public preview of the current game that is being worked on.</h1>

    <div id="gameContainer" class="relative w-full h-screen overflow-hidden">
        <canvas id="animalCanvas"></canvas>
        <div id="loadingOverlay">
            <div>
                Loading Animals...
                <div id="loadingBar">
                    <div id="loadingProgress"></div>
                </div>
            </div>
        </div>

        <div id="infoPanel" class="rounded-xl shadow-lg transition-transform duration-300 ease-out p-6 max-w-sm w-full">
            <h2 id="animalName" class="text-3xl font-extrabold mb-3 text-blue-400"></h2>
            <video id="animalVideo" controls autoplay muted class="w-full h-auto rounded-lg mb-4 bg-black"></video>
            <p id="animalDescription" class="text-gray-300 leading-relaxed mb-4"></p>
            <button id="closeButton" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg w-full">Close</button>
        </div>
    </div>

    <script>
        // Array of animal data including name, description, video link, color, and now a model URL
        const animalData = [
            { name: "Lion", description: "The 'King of the Jungle', known for its powerful roar.", video: "https://houselearning.github.io/home/assets/animalkingdom/lion.mp4", color: 0xf4a460, modelUrl: "https://threejs.org/examples/models/gltf/PrimaryIonDrive/PrimaryIonDrive.glb" },
            { name: "Elephant", description: "The largest land animal, with a remarkable trunk.", video: "https://houselearning.github.io/home/assets/animalkingdom/elephant.mp4", color: 0x808080, modelUrl: "https://threejs.org/examples/models/gltf/PrimaryIonDrive/PrimaryIonDrive.glb" },
            { name: "Giraffe", description: "The tallest mammal, with a very long neck.", video: "https://houselearning.github.io/home/assets/animalkingdom/giraffe.mp4", color: 0xffd700, modelUrl: "https://threejs.org/examples/models/gltf/PrimaryIonDrive/PrimaryIonDrive.glb" },
            { name: "Zebra", description: "Recognizable by its black and white stripes.", video: "https://houselearning.github.io/home/assets/animalkingdom/zebra.mp4", color: 0xffffff, modelUrl: "https://threejs.org/examples/models/gltf/PrimaryIonDrive/PrimaryIonDrive.glb" },
            { name: "Monkey", description: "Agile primates known for their intelligence.", video: "https://houselearning.github.io/home/assets/animalkingdom/monkey.mp4", color: 0xa0522d, modelUrl: "https://threejs.org/examples/models/gltf/PrimaryIonDrive/PrimaryIonDrive.glb" },
            { name: "Penguin", description: "Flightless birds adapted for life in the water.", video: "https://houselearning.github.io/home/assets/animalkingdom/penguin.mp4", color: 0x000000, modelUrl: "https://threejs.org/examples/models/gltf/PrimaryIonDrive/PrimaryIonDrive.glb" },
            { name: "Tiger", description: "A powerful striped feline predator.", video: "https://houselearning.github.io/home/assets/animalkingdom/tiger.mp4", color: 0xffa500, modelUrl: "https://threejs.org/examples/models/gltf/PrimaryIonDrive/PrimaryIonDrive.glb" },
            { name: "Bear", description: "Large mammals with a thick coat of fur.", video: "https://houselearning.github.io/home/assets/animalkingdom/bear.mp4", color: 0x8b4513, modelUrl: "https://threejs.org/examples/models/gltf/PrimaryIonDrive/PrimaryIonDrive.glb" },
            { name: "Wolf", description: "A social canine known for its howling.", video: "https://houselearning.github.io/home/assets/animalkingdom/wolf.mp4", color: 0xd3d3d3, modelUrl: "https://threejs.org/examples/models/gltf/PrimaryIonDrive/PrimaryIonDrive.glb" },
            { name: "Deer", description: "Graceful herbivores with antlers (in males).", video: "https://houselearning.github.io/home/assets/animalkingdom/deer.mp4", color: 0xdeb887, modelUrl: "https://threejs.org/examples/models/gltf/PrimaryIonDrive/PrimaryIonDrive.glb" }
        ];

        // Three.js Scene Setup
        let scene, camera, renderer, controls;
        const animalObjects = []; // Array to store Three.js mesh objects for raycasting
        let modelsLoadedCount = 0; // Keep track of loaded models

        // Get DOM elements for the info panel and loading overlay
        const infoPanel = document.getElementById('infoPanel');
        const animalNameElem = document.getElementById('animalName');
        const animalVideoElem = document.getElementById('animalVideo');
        const animalDescriptionElem = document.getElementById('animalDescription');
        const closeButton = document.getElementById('closeButton');
        const canvas = document.getElementById('animalCanvas');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const loadingProgress = document.getElementById('loadingProgress');

        // Initialize the Three.js scene
        function init() {
            // Create the scene
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x282c34); // Dark gray background

            // Create the camera
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 15, 40); // Position camera to see all animals, adjusted for GLTF models

            // Create the renderer
            renderer = new THREE.WebGLRenderer({ canvas: canvas, antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio); // Adjust for high-res screens

            // Add OrbitControls for interactive camera movement
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true; // Enable smooth camera movement
            controls.dampingFactor = 0.05;
            controls.screenSpacePanning = false;
            controls.minDistance = 5;
            controls.maxDistance = 100;
            controls.target.set(0, 5, 0); // Point controls at the center of the animal circle

            // Add lighting to the scene
            const ambientLight = new THREE.AmbientLight(0x404040, 3); // Soft white light, increased intensity
            scene.add(ambientLight);

            const directionalLight1 = new THREE.DirectionalLight(0xffffff, 1.5); // White directional light
            directionalLight1.position.set(10, 20, 10);
            directionalLight1.castShadow = true;
            scene.add(directionalLight1);

            const directionalLight2 = new THREE.DirectionalLight(0xffffff, 1); // Another light from a different angle
            directionalLight2.position.set(-10, 15, -5);
            scene.add(directionalLight2);

            // Create a ground plane
            const planeGeometry = new THREE.PlaneGeometry(100, 100);
            const planeMaterial = new THREE.MeshStandardMaterial({ color: 0x4a7c59, side: THREE.DoubleSide }); // Green ground, using StandardMaterial for better lighting
            const plane = new THREE.Mesh(planeGeometry, planeMaterial);
            plane.rotation.x = -Math.PI / 2; // Rotate to lay flat
            plane.receiveShadow = true;
            scene.add(plane);

            // Load and position GLTF animal models
            loadAnimals();

            // Event listeners
            window.addEventListener('resize', onWindowResize);
            canvas.addEventListener('click', onCanvasClick);
            closeButton.addEventListener('click', hideInfoPanel);
        }

        // Function to load 3D GLTF models for animals
        function loadAnimals() {
            const loader = new THREE.GLTFLoader();

            // Calculate positions in a circular layout
            const radius = 20;
            const angleIncrement = (Math.PI * 2) / animalData.length;

            animalData.forEach((animal, index) => {
                const x = radius * Math.cos(index * angleIncrement);
                const z = radius * Math.sin(index * angleIncrement);

                // For each animal, load its GLTF model
                loader.load(animal.modelUrl, function (gltf) {
                    const model = gltf.scene;

                    // --- IMPORTANT: Adjust these values for each specific animal model ---
                    // GLTF models can have varying scales and pivot points.
                    // You will likely need to adjust these `scale` and `position` values
                    // for each unique animal model to make them look correct.
                    model.scale.set(1.5, 1.5, 1.5); // Example scale, adjust as needed
                    model.position.set(x, 0, z); // Position at the calculated circular point, Y=0 to sit on ground

                    // Set user data for raycasting
                    model.userData = animal;
                    model.name = animal.name; // Assign a name for easier debugging

                    // Traverse the model's children to enable shadows and attach user data
                    model.traverse(function (child) {
                        if (child.isMesh) {
                            child.castShadow = true;
                            child.receiveShadow = true;
                            // Optionally apply the animal's color to the model's material
                            // child.material = new THREE.MeshStandardMaterial({ color: animal.color });
                            child.userData = animal; // Attach data to child meshes for more precise raycasting
                        }
                    });

                    scene.add(model);
                    animalObjects.push(model); // Add the model's root scene for raycasting

                    addAnimalLabel(model, animal.name); // Add the text label above the loaded model

                    modelsLoadedCount++;
                    updateLoadingProgress();
                    if (modelsLoadedCount === animalData.length) {
                        loadingOverlay.style.display = 'none'; // Hide loading overlay when all models are loaded
                    }

                }, function (xhr) {
                    // Progress callback (optional)
                    // console.log((xhr.loaded / xhr.total * 100) + '% loaded of ' + animal.name);
                }, function (error) {
                    console.error('Error loading GLTF model for', animal.name, error);
                    // Fallback: If a model fails to load, you might want to add a placeholder sphere
                    // or handle the error gracefully here. For now, it will just log the error.
                    modelsLoadedCount++; // Still increment to hide loading overlay
                    updateLoadingProgress();
                    if (modelsLoadedCount === animalData.length) {
                        loadingOverlay.style.display = 'none';
                    }
                });
            });
        }

        // Updates the loading bar progress
        function updateLoadingProgress() {
            const progress = (modelsLoadedCount / animalData.length) * 100;
            loadingProgress.style.width = `${progress}%`;
        }

        // Animation loop
        function animate() {
            requestAnimationFrame(animate); // Loop indefinitely
            controls.update(); // Update orbit controls
            renderer.render(scene, camera); // Render the scene
        }

        // Handle window resizing
        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        // Raycasting for object interaction
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();

        function onCanvasClick(event) {
            // Calculate mouse position in normalized device coordinates (-1 to +1)
            mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;

            // Update the raycaster with the camera and mouse position
            raycaster.setFromCamera(mouse, camera);

            // Find intersecting objects, checking all descendants
            const intersects = raycaster.intersectObjects(animalObjects, true); // true for recursive check

            if (intersects.length > 0) {
                // Find the top-most parent that has the animal's userData
                let clickedAnimalModel = null;
                for (let i = 0; i < intersects.length; i++) {
                    let currentObject = intersects[i].object;
                    while (currentObject) {
                        if (currentObject.userData && currentObject.userData.name) {
                            clickedAnimalModel = currentObject;
                            break;
                        }
                        currentObject = currentObject.parent;
                    }
                    if (clickedAnimalModel) break;
                }

                if (clickedAnimalModel) {
                    const animalInfo = clickedAnimalModel.userData; // Retrieve stored animal data
                    displayAnimalInfo(animalInfo);
                } else {
                    hideInfoPanel();
                }
            } else {
                hideInfoPanel(); // Hide if no animal is clicked
            }
        }

        // Function to add a text label (Sprite) above each animal
        function addAnimalLabel(model, name) {
            const canvasForText = document.createElement('canvas');
            const context = canvasForText.getContext('2d');
            const fontSize = 80; // Adjust font size for better readability
            context.font = `${fontSize}px Arial`;
            context.fillStyle = 'white';
            context.textAlign = 'center';
            context.textBaseline = 'middle';
            const padding = 10;
            const textWidth = context.measureText(name).width;
            canvasForText.width = textWidth + padding * 2;
            canvasForText.height = fontSize + padding * 2; // Increased height for padding

            // Re-draw text with updated canvas size
            context.font = `${fontSize}px Arial`;
            context.fillStyle = 'white';
            context.textAlign = 'center';
            context.textBaseline = 'middle';
            context.fillText(name, canvasForText.width / 2, canvasForText.height / 2);

            const texture = new THREE.CanvasTexture(canvasForText);
            const material = new THREE.SpriteMaterial({ map: texture });
            const sprite = new THREE.Sprite(material);

            // Scale sprite based on text size
            const aspectRatio = canvasForText.width / canvasForText.height;
            const spriteHeight = 4; // Arbitrary height for the sprite
            sprite.scale.set(spriteHeight * aspectRatio, spriteHeight, 1);

            // Position sprite above the animal model (assuming model's pivot is at its base)
            // You might need to adjust this Y position based on the specific GLTF model's dimensions
            const boundingBox = new THREE.Box3().setFromObject(model);
            const modelHeight = boundingBox.max.y - boundingBox.min.y;
            sprite.position.set(0, modelHeight + spriteHeight / 2 + 1, 0); // Above the model

            model.add(sprite); // Add sprite as a child of the animal model
        }


        // Display animal information in the panel
        function displayAnimalInfo(animal) {
            animalNameElem.textContent = animal.name;
            animalDescriptionElem.textContent = animal.description;
            animalVideoElem.src = animal.video;
            animalVideoElem.play(); // Auto-play video
            animalVideoElem.muted = false; // Unmute by default when displayed

            infoPanel.classList.add('active'); // Show the info panel
        }

        // Hide the info panel
        function hideInfoPanel() {
            infoPanel.classList.remove('active'); // Hide the info panel
            animalVideoElem.pause(); // Pause video when panel is hidden
            animalVideoElem.currentTime = 0; // Reset video to start
        }

        // Start the game when the window loads
        window.onload = function () {
            init(); // Initialize Three.js scene
            animate(); // Start the animation loop
        };
    </script>
</body>
</html>
