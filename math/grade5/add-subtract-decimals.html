<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Grade 5 — Adding and Subtracting Decimals</title>
<style>
:root{
  --bg:#f7fbff; --panel:#fff; --accent:#60a5fa; --accent2:#1d4ed8; --ok:#16a34a; --bad:#ef4444; --muted:#566270;
}
*{box-sizing:border-box}
body{margin:0;font-family:Inter, "Segoe UI", Arial, sans-serif;background:var(--bg);color:#04263b;}
header{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#fff;padding:22px 12px;text-align:center}
header h1{margin:0;font-size:clamp(20px,3vw,30px)}
main{max-width:1100px;margin:20px auto;padding:14px}
section{background:var(--panel);border-radius:12px;padding:16px;margin:14px 0;box-shadow:0 8px 24px rgba(2,6,23,0.06)}
h2{color:var(--accent2);margin:0 0 10px 0}
p{margin:8px 0}
.controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
button{background:var(--accent2);color:#fff;border:none;padding:10px 12px;border-radius:10px;cursor:pointer;font-weight:700}
button.secondary{background:#60a5fa;color:#fff}
button.ghost{background:#dbeafe;color:var(--accent2);border:1px solid #93c5fd}
button.warn{background:#f97316}
input[type=number], input[type=text], select{padding:8px;border-radius:8px;border:1px solid #93c5fd;font-size:1rem}
.grid{display:grid;gap:10px}
.grid.cols-4{grid-template-columns:repeat(4,1fr)}
.tile{background:#fff;padding:12px;border-radius:8px;text-align:center;border:1px solid #93c5fd;cursor:pointer;font-weight:700}
.status{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
.pill{background:#e6ffef;color:var(--ok);padding:6px 10px;border-radius:999px;font-weight:800}
.muted{color:var(--muted)}
footer{text-align:center;padding:12px;margin-top:8px;color:#334155}
.answer{font-weight:800;margin-top:8px}
.ok{color:var(--ok)}
.bad{color:var(--bad)}
canvas{background:#fff;border:1px solid #93c5fd;border-radius:8px;display:block;margin-top:10px;}
</style>
</head>
<body>
<header>
<h1>Grade 5 — Adding and Subtracting Decimals</h1>
<p style="margin:6px 0 0 0;opacity:.95">Interactive practice • challenge problems • speed quiz • tutorial video • CSV download</p>
</header>

<main>
<section aria-labelledby="introTitle">
<h2 id="introTitle">Intro & Concept</h2>
<p>To add and subtract decimals, you must **line up the decimal points**! This is the most important step. Once the decimal points are lined up, you can add or subtract just like you would with whole numbers. Don't forget to add zeros to make the numbers the same length! 📏</p>
<div class="status" style="margin-top:8px">
  <div class="pill" id="score">Score: 0</div>
  <div class="muted" id="streak">Streak: 0</div>
</div>
</section>

<section aria-labelledby="videoTitle">
<h2 id="videoTitle">Animated Tutorial Video</h2>
<p>Click Play to watch a detailed animated example of adding and subtracting decimals.</p>
<div class="canvas-wrapper">
  <canvas id="tutorialCanvas" width="800" height="400"></canvas>
</div>
<div class="controls">
  <button id="playTutorial" class="secondary">▶️ Play Tutorial</button>
  <button id="downloadVideo" class="ghost">💾 Download Video</button>
</div>
<div class="settings">
  <label>Speed: <input type="number" id="videoSpeed" value="1" min="0.1" max="3" step="0.1"></label>
</div>
</section>

<section aria-labelledby="practiceTitle">
<h2 id="practiceTitle">Interactive Practice</h2>
<p>Solve these problems and type your answer. Be sure to include the decimal point.</p>
<div class="grid cols-4" style="margin-top:10px">
  <div class="tile">
    <div style="font-weight:700">1) 2.5 + 3.4</div>
    <input id="q1" type="text" placeholder="Answer e.g. 5.9">
    <div style="margin-top:6px"><button onclick="check('q1','5.9')">Check</button></div>
    <div id="r1" class="answer"></div>
  </div>
  <div class="tile">
    <div style="font-weight:700">2) 7.8 - 4.1</div>
    <input id="q2" type="text" placeholder="Answer e.g. 3.7">
    <div style="margin-top:6px"><button onclick="check('q2','3.7')">Check</button></div>
    <div id="r2" class="answer"></div>
  </div>
  <div class="tile">
    <div style="font-weight:700">3) 6.2 + 1.55</div>
    <input id="q3" type="text" placeholder="Answer e.g. 7.75">
    <div style="margin-top:6px"><button onclick="check('q3','7.75')">Check</button></div>
    <div id="r3" class="answer"></div>
  </div>
  <div class="tile">
    <div style="font-weight:700">4) 10.5 - 3.75</div>
    <input id="q4" type="text" placeholder="Answer e.g. 6.75">
    <div style="margin-top:6px"><button onclick="check('q4','6.75')">Check</button></div>
    <div id="r4" class="answer"></div>
  </div>
</div>
</section>

<section aria-labelledby="challengeTitle">
<h2 id="challengeTitle">Random Challenge</h2>
<div class="controls" style="margin-top:10px;align-items:center">
  <div style="font-size:1.2rem;font-weight:800" id="challengeQ">—</div>
  <input id="challengeInput" type="text" placeholder="Answer">
  <button id="challengeCheck">Check</button>
  <button id="challengeNew" class="secondary">New Question</button>
  <div id="challengeResult" class="answer"></div>
</div>
</section>

<section aria-labelledby="speedTitle">
<h2 id="speedTitle">⚡ Speed Quiz</h2>
<div class="controls">
  <label>Duration:
    <select id="quizDuration">
      <option value="30">30s</option>
      <option value="60" selected>60s</option>
      <option value="90">90s</option>
    </select>
  </label>
  <button id="startQuiz" class="warn">Start Quiz</button>
  <button id="stopQuiz" class="ghost">Stop</button>
  <div class="muted" id="quizTimer">Time: 0</div>
  <div id="quizScore" class="pill">Correct: 0</div>
</div>
<div style="margin-top:12px">
  <div style="font-size:1.6rem;font-weight:800" id="quizQ">Press Start</div>
  <div style="margin-top:8px" class="controls">
    <input id="quizInput" type="text" placeholder="Answer">
    <button id="quizCheck" class="secondary">Submit</button>
    <div id="quizFeedback" class="answer"></div>
  </div>
</div>
</section>

<section aria-labelledby="csvTitle">
<h2 id="csvTitle">Download CSV Log</h2>
<p>Track all practice & quiz answers in a CSV file.</p>
<button id="downloadCSVBtn" class="secondary">⬇️ Download CSV</button>
</section>

<footer>Tip: Imagine adding or subtracting money to help you line up the decimal points!</footer>
</main>

<script>
/* ===== Utilities ===== */
const tone=(f=880,d=0.06)=>{try{const A=new (window.AudioContext||window.webkitAudioContext)();const o=A.createOscillator();const g=A.createGain();o.type='sine';o.frequency.value=f;g.gain.value=0.0001;o.connect(g);g.connect(A.destination);o.start();g.gain.exponentialRampToValueAtTime(0.12,A.currentTime+0.01);g.gain.exponentialRampToValueAtTime(0.0001,A.currentTime+d);setTimeout(()=>{o.stop();A.close().catch(()=>{});},d*1000+50);}catch(e){}};
function gcd(a, b) { return b === 0 ? a : gcd(b, a % b); }

/* ===== Score & CSV ===== */
let totalScore=0, streak=0, csvData=[];
function updateScore(points,q='',a=''){if(points>0){ totalScore+=points; streak++;}else{streak=0;} document.getElementById('score').textContent=`Score: ${totalScore}`; document.getElementById('streak').textContent=`Streak: ${streak}`; if(q&&a)csvData.push([q,a]);}
function check(inputId,correct){const val=document.getElementById(inputId).value.trim(); const res=document.getElementById('r'+inputId.replace(/[^\d]/g,'')); if(val.toLowerCase()===correct.toLowerCase()){res.textContent='✅ Correct!'; res.className='answer ok'; tone(880,0.06); updateScore(1,document.getElementById(inputId).previousElementSibling.textContent,correct);}else{res.textContent=`❌ Wrong (Answer: ${correct})`; res.className='answer bad'; tone(220,0.06); updateScore(0,document.getElementById(inputId).previousElementSibling.textContent,correct);}}

/* ===== Canvas Tutorial ===== */
const canvas=document.getElementById('tutorialCanvas');
const ctx=canvas.getContext('2d');
ctx.font="30px Arial"; ctx.textAlign="center"; ctx.textBaseline="middle";
const speedInput=document.getElementById('videoSpeed');

function drawDecimalProblem(num1, num2, operator, step) {
    ctx.clearRect(0, 0, 800, 400);
    ctx.font = "40px Arial";

    const startX = 300, startY = 150;
    const padding = 100;
    const decimalSymbol = '.';

    const n1 = num1.toString();
    const n2 = num2.toString();

    // Find the position of the decimal point
    const decPos1 = n1.indexOf(decimalSymbol);
    const decPos2 = n2.indexOf(decimalSymbol);

    // Calculate maximum digits after decimal for alignment
    const maxDecimals = Math.max(
        decPos1 !== -1 ? n1.length - 1 - decPos1 : 0,
        decPos2 !== -1 ? n2.length - 1 - decPos2 : 0
    );

    // Format numbers for drawing
    const formattedNum1 = n1 + (decPos1 === -1 ? '.' : '') + '0'.repeat(maxDecimals - (decPos1 !== -1 ? n1.length - 1 - decPos1 : 0));
    const formattedNum2 = n2 + (decPos2 === -1 ? '.' : '') + '0'.repeat(maxDecimals - (decPos2 !== -1 ? n2.length - 1 - decPos2 : 0));

    // Draw numbers with aligned decimal points
    const decimalX = startX + (formattedNum1.indexOf(decimalSymbol) - formattedNum1.length) * 20;

    // Drawing Logic
    ctx.fillStyle = "#000";
    ctx.font = "40px Arial";
    ctx.fillText(formattedNum1, decimalX, startY - 20);
    ctx.fillText(operator, decimalX - 60, startY + 20);
    ctx.fillText(formattedNum2, decimalX, startY + 20);
    ctx.fillRect(decimalX - 100, startY + 40, 200, 2);

    // Animate steps
    ctx.font = "20px Arial";
    if (step === 1) {
        ctx.fillStyle = "#16a34a";
        ctx.fillText("Step 1: The most important rule!", 400, 350);
        ctx.fillText("Line up the decimal points! ✨", 400, 380);
        ctx.fillStyle = "#f97316";
        ctx.fillText('.', decimalX, startY - 20);
        ctx.fillText('.', decimalX, startY + 20);
    } else if (step === 2) {
        ctx.fillStyle = "#1d4ed8";
        ctx.fillText("Step 2: Add zeros to fill in the empty spaces.", 400, 350);
        ctx.fillText(formattedNum1.includes('.') ? formattedNum1 : formattedNum1 + '.0', decimalX, startY - 20);
        ctx.fillText(formattedNum2.includes('.') ? formattedNum2 : formattedNum2 + '.0', decimalX, startY + 20);
    } else if (step === 3) {
        ctx.fillStyle = "#000";
        const result = operator === '+' ? num1 + num2 : num1 - num2;
        ctx.font = "40px Arial";
        ctx.fillText(result.toFixed(maxDecimals), decimalX, startY + 80);
        ctx.font = "20px Arial";
        ctx.fillText("Step 3: Solve just like a normal addition or subtraction problem!", 400, 350);
    }
}

const tutorialSteps = [
    { audio: "Let's solve the problem 6.2 plus 1.55.", draw: () => drawDecimalProblem(6.2, 1.55, '+', 0) },
    { audio: "The first step is to line up the decimal points. This ensures you're adding the right place values.", draw: () => drawDecimalProblem(6.2, 1.55, '+', 1) },
    { audio: "Add a zero to the end of the first number so both have the same number of decimal places. 6.2 becomes 6.20.", draw: () => drawDecimalProblem(6.2, 1.55, '+', 2) },
    { audio: "Now, simply add the numbers together, just as you would with whole numbers, and bring down the decimal point into your answer. The sum is 7.75.", draw: () => drawDecimalProblem(6.2, 1.55, '+', 3) },
    { audio: "Let's try a subtraction problem: 10.5 minus 3.75.", draw: () => drawDecimalProblem(10.5, 3.75, '-', 0) },
    { audio: "Again, we line up the decimal points. We can add a zero to the end of 10.5 to make it 10.50.", draw: () => drawDecimalProblem(10.5, 3.75, '-', 2) },
    { audio: "Subtract the numbers, borrowing when needed. The difference is 6.75.", draw: () => drawDecimalProblem(10.5, 3.75, '-', 3) }
];

let tutorialIndex = 0;
function playTutorialVideo(callback) {
  tutorialIndex = 0;
  const speed = parseFloat(speedInput.value) || 1;
  function nextStep() {
    if (tutorialIndex >= tutorialSteps.length) {
      if (callback) callback();
      return;
    }
    const step = tutorialSteps[tutorialIndex];
    step.draw();
    const utter = new SpeechSynthesisUtterance(step.audio);
    utter.rate = speed;
    utter.onend = () => {
      tutorialIndex++;
      nextStep();
    };
    utter.onerror = () => {
      tutorialIndex++;
      nextStep();
    };
    speechSynthesis.speak(utter);
  }
  nextStep();
}
document.getElementById('playTutorial').addEventListener('click', () => playTutorialVideo());

/* ===== Video Download ===== */
document.getElementById('downloadVideo').addEventListener('click', () => {
  const stream = canvas.captureStream(30);
  const recorder = new MediaRecorder(stream);
  const chunks = [];
  recorder.ondataavailable = e => chunks.push(e.data);
  recorder.onstop = e => {
    const blob = new Blob(chunks, { type: 'video/webm' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'decimal_tutorial.webm'; a.click();
    URL.revokeObjectURL(url);
  };
  recorder.start();
  playTutorialVideo(() => { setTimeout(() => recorder.stop(), 500); });
});

/* ===== Random Challenge ===== */
function generateProblem() {
    const isAddition = Math.random() < 0.5;
    let num1 = parseFloat((Math.random() * 100).toFixed(Math.floor(Math.random() * 2) + 1));
    let num2 = parseFloat((Math.random() * 100).toFixed(Math.floor(Math.random() * 2) + 1));

    if (isAddition) {
        const result = (num1 + num2).toFixed(Math.max(num1.toString().split('.')[1]?.length || 0, num2.toString().split('.')[1]?.length || 0));
        return { q: `${num1} + ${num2}`, a: parseFloat(result).toString() };
    } else {
        if (num1 < num2) { [num1, num2] = [num2, num1]; }
        const result = (num1 - num2).toFixed(Math.max(num1.toString().split('.')[1]?.length || 0, num2.toString().split('.')[1]?.length || 0));
        return { q: `${num1} - ${num2}`, a: parseFloat(result).toString() };
    }
}
let currentCorrect = null;

function newChallenge() {
  const problem = generateProblem();
  currentCorrect = problem.a;
  document.getElementById('challengeQ').textContent = problem.q + ' = ?';
  document.getElementById('challengeInput').value = '';
  document.getElementById('challengeResult').textContent = '';
}
document.getElementById('challengeNew').addEventListener('click', newChallenge);
document.getElementById('challengeCheck').addEventListener('click', () => {
  const val = document.getElementById('challengeInput').value.trim();
  const res = document.getElementById('challengeResult');
  if (val === currentCorrect) {
    res.textContent = '✅ Correct!';
    res.className = 'answer ok';
    tone(880, 0.06);
    updateScore(1, document.getElementById('challengeQ').textContent, currentCorrect);
  } else {
    res.textContent = `❌ Wrong (Answer: ${currentCorrect})`;
    res.className = 'answer bad';
    tone(220, 0.06);
    updateScore(0, document.getElementById('challengeQ').textContent, currentCorrect);
  }
});
newChallenge();

/* ===== Speed Quiz ===== */
let quizTimerInt = null, quizTime = 0, quizScore = 0, currentQuiz = null;

function newQuizQuestion() {
  const problem = generateProblem();
  currentQuiz = problem;
  document.getElementById('quizQ').textContent = currentQuiz.q + ' = ?';
  document.getElementById('quizInput').value = '';
  document.getElementById('quizFeedback').textContent = '';
}

document.getElementById('startQuiz').addEventListener('click', () => {
  quizTime = parseInt(document.getElementById('quizDuration').value, 10);
  quizScore = 0;
  document.getElementById('quizScore').textContent = `Correct: ${quizScore}`;
  newQuizQuestion();
  clearInterval(quizTimerInt);
  quizTimerInt = setInterval(() => {
    quizTime--;
    document.getElementById('quizTimer').textContent = `Time: ${quizTime}s`;
    if (quizTime <= 0) {
      clearInterval(quizTimerInt);
      document.getElementById('quizQ').textContent = 'Time Up!';
    }
  }, 1000);
});
document.getElementById('stopQuiz').addEventListener('click', () => {
  clearInterval(quizTimerInt);
});
document.getElementById('quizCheck').addEventListener('click', () => {
  const val = document.getElementById('quizInput').value.trim();
  const f = document.getElementById('quizFeedback');
  if (val === currentQuiz.a) {
    f.textContent = '✅ Correct!';
    f.className = 'answer ok';
    quizScore++;
    document.getElementById('quizScore').textContent = `Correct: ${quizScore}`;
    tone(880, 0.06);
    csvData.push([currentQuiz.q, currentQuiz.a]);
  } else {
    f.textContent = `❌ Wrong (Answer: ${currentQuiz.a})`;
    f.className = 'answer bad';
    tone(220, 0.06);
    csvData.push([currentQuiz.q, currentQuiz.a]);
  }
  newQuizQuestion();
});

/* ===== CSV Download ===== */
document.getElementById('downloadCSVBtn').addEventListener('click', () => {
  const csvContent = csvData.map(e => e.join(',')).join('\n');
  const blob = new Blob([csvContent], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'decimal_practice.csv'; a.click();
  URL.revokeObjectURL(url);
});
</script>
</body>
</html>
