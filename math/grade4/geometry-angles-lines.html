<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Grade 4 ‚Äî Geometry (Angles & Lines)</title>
<style>
:root{
  --bg:#f7fbff; --panel:#fff; --accent:#f87171; --accent2:#b91c1c; --ok:#16a34a; --bad:#ef4444; --muted:#566270;
}
*{box-sizing:border-box}
body{margin:0;font-family:Inter, "Segoe UI", Arial, sans-serif;background:var(--bg);color:#04263b;}
header{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#fff;padding:22px 12px;text-align:center}
header h1{margin:0;font-size:clamp(20px,3vw,30px)}
main{max-width:1100px;margin:20px auto;padding:14px}
section{background:var(--panel);border-radius:12px;padding:16px;margin:14px 0;box-shadow:0 8px 24px rgba(2,6,23,0.06)}
h2{color:var(--accent2);margin:0 0 10px 0}
p{margin:8px 0}
.controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
button{background:var(--accent2);color:#fff;border:none;padding:10px 12px;border-radius:10px;cursor:pointer;font-weight:700}
button.secondary{background:#f87171;color:#fff}
button.ghost{background:#fee2e2;color:var(--accent2);border:1px solid #fecaca}
button.warn{background:#f97316}
input[type=number], input[type=text], select{padding:8px;border-radius:8px;border:1px solid #fecaca;font-size:1rem}
.grid{display:grid;gap:10px}
.grid.cols-4{grid-template-columns:repeat(4,1fr)}
.tile{background:#fff;padding:12px;border-radius:8px;text-align:center;border:1px solid #fecaca;cursor:pointer;font-weight:700}
.status{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
.pill{background:#e6ffef;color:var(--ok);padding:6px 10px;border-radius:999px;font-weight:800}
.muted{color:var(--muted)}
footer{text-align:center;padding:12px;margin-top:8px;color:#334155}
.answer{font-weight:800;margin-top:8px}
.ok{color:var(--ok)}
.bad{color:var(--bad)}
canvas{background:#fff;border:1px solid #fecaca;border-radius:8px;display:block;margin-top:10px;}
</style>
</head>
<body>
<header>
<h1>Grade 4 ‚Äî Geometry (Angles & Lines)</h1>
<p style="margin:6px 0 0 0;opacity:.95">Interactive practice ‚Ä¢ challenge problems ‚Ä¢ speed quiz ‚Ä¢ tutorial video ‚Ä¢ CSV download</p>
</header>

<main>
<!-- Intro -->
<section aria-labelledby="introTitle">
<h2 id="introTitle">Intro & Concept</h2>
<p>Angles measure how far one line turns from another. Lines can be <strong>parallel, perpendicular</strong>, or <strong>intersecting</strong>. Common angles: <strong>acute &lt;90¬∞</strong>, <strong>right = 90¬∞</strong>, <strong>obtuse &gt;90¬∞</strong>.</p>
<div class="status" style="margin-top:8px">
  <div class="pill" id="score">Score: 0</div>
  <div class="muted" id="streak">Streak: 0</div>
</div>
</section>

<!-- Tutorial Video -->
<section aria-labelledby="videoTitle">
<h2 id="videoTitle">Animated Tutorial Video</h2>
<p>Click Play to watch examples of angles and lines. Captions appear on the canvas and will be included in the downloaded video.</p>
<div class="canvas-wrapper">
  <canvas id="tutorialCanvas" width="600" height="300"></canvas>
</div>
<div class="controls">
  <button id="playTutorial" class="secondary">‚ñ∂Ô∏è Play Tutorial</button>
  <button id="downloadVideo" class="ghost">üíæ Download Video</button>
</div>
<div class="settings">
  <label>Speed: <input type="number" id="videoSpeed" value="1" min="0.1" max="3" step="0.1"></label>
</div>
</section>

<!-- Interactive Practice -->
<section aria-labelledby="practiceTitle">
<h2 id="practiceTitle">Interactive Practice</h2>
<div class="grid cols-4" style="margin-top:10px">
  <div class="tile">
    <div style="font-weight:700">1) Identify angle: 45¬∞</div>
    <input id="q1" type="text" placeholder="Answer e.g. Acute">
    <div style="margin-top:6px"><button onclick="check('q1','Acute')">Check</button></div>
    <div id="r1" class="answer"></div>
  </div>
  <div class="tile">
    <div style="font-weight:700">2) Identify angle: 90¬∞</div>
    <input id="q2" type="text" placeholder="Answer e.g. Right">
    <div style="margin-top:6px"><button onclick="check('q2','Right')">Check</button></div>
    <div id="r2" class="answer"></div>
  </div>
  <div class="tile">
    <div style="font-weight:700">3) Identify lines: never meet</div>
    <input id="q3" type="text" placeholder="Answer e.g. Parallel">
    <div style="margin-top:6px"><button onclick="check('q3','Parallel')">Check</button></div>
    <div id="r3" class="answer"></div>
  </div>
  <div class="tile">
    <div style="font-weight:700">4) Lines intersect at right angle</div>
    <input id="q4" type="text" placeholder="Answer e.g. Perpendicular">
    <div style="margin-top:6px"><button onclick="check('q4','Perpendicular')">Check</button></div>
    <div id="r4" class="answer"></div>
  </div>
</div>
</section>

<!-- Random Challenge -->
<section aria-labelledby="challengeTitle">
<h2 id="challengeTitle">Random Challenge</h2>
<div class="controls" style="margin-top:10px;align-items:center">
  <div style="font-size:1.2rem;font-weight:800" id="challengeQ">‚Äî</div>
  <input id="challengeInput" type="text" placeholder="Answer">
  <button id="challengeCheck">Check</button>
  <button id="challengeNew" class="secondary">New Question</button>
  <div id="challengeResult" class="answer"></div>
</div>
</section>

<!-- Speed Quiz -->
<section aria-labelledby="speedTitle">
<h2 id="speedTitle">‚ö° Speed Quiz</h2>
<div class="controls">
  <label>Duration:
    <select id="quizDuration">
      <option value="30">30s</option>
      <option value="60" selected>60s</option>
      <option value="90">90s</option>
    </select>
  </label>
  <button id="startQuiz" class="warn">Start Quiz</button>
  <button id="stopQuiz" class="ghost">Stop</button>
  <div class="muted" id="quizTimer">Time: 0</div>
  <div id="quizScore" class="pill">Correct: 0</div>
</div>
<div style="margin-top:12px">
  <div style="font-size:1.6rem;font-weight:800" id="quizQ">Press Start</div>
  <div style="margin-top:8px" class="controls">
    <input id="quizInput" type="text" placeholder="Answer">
    <button id="quizCheck" class="secondary">Submit</button>
    <div id="quizFeedback" class="answer"></div>
  </div>
</div>
</section>

<!-- CSV Download -->
<section aria-labelledby="csvTitle">
<h2 id="csvTitle">Download CSV Log</h2>
<p>Track all practice & quiz answers in a CSV file.</p>
<button id="downloadCSVBtn" class="secondary">‚¨áÔ∏è Download CSV</button>
</section>

<footer>Tip: Use a protractor to measure angles and identify line relationships!</footer>
</main>

<script>
// ===== utilities =====
const tone=(f=880,d=0.06)=>{
  try{
    const A=new (window.AudioContext||window.webkitAudioContext)();
    const o=A.createOscillator();
    const g=A.createGain();
    o.type='sine';
    o.frequency.value=f;
    g.gain.value=0.0001;
    o.connect(g); g.connect(A.destination); o.start();
    g.gain.exponentialRampToValueAtTime(0.12,A.currentTime+0.01);
    g.gain.exponentialRampToValueAtTime(0.0001,A.currentTime+d);
    setTimeout(()=>{o.stop();A.close().catch(()=>{});},d*1000+50);
  }catch(e){}
};

// ===== Score & CSV =====
let totalScore=0, streak=0, csvData=[];
function updateScore(points,q='',a=''){
  if(points>0){ totalScore+=points; streak++; } else { streak=0; }
  document.getElementById('score').textContent=`Score: ${totalScore}`;
  document.getElementById('streak').textContent=`Streak: ${streak}`;
  if(q && a) csvData.push([q,a]);
}
function check(inputId,correct){
  const val=document.getElementById(inputId).value.trim();
  const res=document.getElementById('r'+inputId.replace(/[^\d]/g,''));
  if(val.toLowerCase()===correct.toLowerCase()){
    res.textContent='‚úÖ Correct!';
    res.className='answer ok';
    tone(880,0.06);
    updateScore(1,document.getElementById(inputId).previousElementSibling.textContent,correct);
  } else {
    res.textContent=`‚ùå Wrong (Answer: ${correct})`;
    res.className='answer bad';
    tone(220,0.06);
    updateScore(0,document.getElementById(inputId).previousElementSibling.textContent,correct);
  }
}

// ===== Tutorial Video =====
const canvas=document.getElementById('tutorialCanvas');
const ctx=canvas.getContext('2d');
ctx.font="24px Arial"; ctx.textAlign="center"; ctx.textBaseline="middle";
const speedInput=document.getElementById('videoSpeed');

const tutorialSteps=[
  {caption:"Step 1: Draw a right angle", draw:()=>{ctx.clearRect(0,0,600,300); ctx.beginPath(); ctx.moveTo(150,200); ctx.lineTo(150,100); ctx.lineTo(250,100); ctx.stroke();}, audio:"Draw a right angle using two lines."},
  {caption:"Step 2: Draw an acute angle", draw:()=>{ctx.clearRect(0,0,600,300); ctx.beginPath(); ctx.moveTo(400,200); ctx.lineTo(400,100); ctx.lineTo(450,150); ctx.stroke();}, audio:"Draw an acute angle less than 90 degrees."},
];

let tutorialIndex=0;
function playTutorialVideo(callback){
  tutorialIndex=0;
  const speed=parseFloat(speedInput.value)||1;
  function nextStep(){
    if(tutorialIndex>=tutorialSteps.length){ if(callback) callback(); return; }
    const step=tutorialSteps[tutorialIndex];
    step.draw();
    const utter=new SpeechSynthesisUtterance(step.audio);
    utter.rate=speed;
    speechSynthesis.speak(utter);
    tutorialIndex++;
    setTimeout(nextStep,3000/speed);
  }
  nextStep();
}
document.getElementById('playTutorial').addEventListener('click',()=>playTutorialVideo());

// ===== Video download =====
document.getElementById('downloadVideo').addEventListener('click',()=>{
  const speed=parseFloat(speedInput.value)||1;
  const stream=canvas.captureStream(30);
  const recorder=new MediaRecorder(stream);
  const chunks=[];
  recorder.ondataavailable=e=>chunks.push(e.data);
  recorder.onstop=e=>{
    const blob=new Blob(chunks,{type:'video/webm'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download='geometry_tutorial.webm'; a.click();
    URL.revokeObjectURL(url);
  };
  recorder.start();
  playTutorialVideo(()=>{setTimeout(()=>recorder.stop(),500);});
});

// ===== Random Challenge =====
let challengeList=[
  {q:"Identify angle: 30¬∞", a:"Acute"},
  {q:"Identify angle: 120¬∞", a:"Obtuse"},
  {q:"Lines never meet", a:"Parallel"},
  {q:"Lines meet at 90¬∞", a:"Perpendicular"}
];
let currentCorrect=null;
function newChallenge(){
  const idx=Math.floor(Math.random()*challengeList.length);
  currentCorrect=challengeList[idx].a;
  document.getElementById('challengeQ').textContent=challengeList[idx].q+' = ?';
  document.getElementById('challengeInput').value='';
  document.getElementById('challengeResult').textContent='';
}
document.getElementById('challengeNew').addEventListener('click',newChallenge);
document.getElementById('challengeCheck').addEventListener('click',()=>{
  const val=document.getElementById('challengeInput').value.trim();
  const res=document.getElementById('challengeResult');
  if(val.toLowerCase()===currentCorrect.toLowerCase()){ res.textContent='‚úÖ Correct!'; res.className='answer ok'; tone(880,0.06); updateScore(1,document.getElementById('challengeQ').textContent,currentCorrect);}
  else{ res.textContent=`‚ùå Wrong (Answer: ${currentCorrect})`; res.className='answer bad'; tone(220,0.06); updateScore(0,document.getElementById('challengeQ').textContent,currentCorrect);}
});
newChallenge();

// ===== Speed Quiz =====
let quizTimerInt=null, quizTime=0, quizScore=0, currentQuiz=null;
function newQuizQuestion(){
  const idx=Math.floor(Math.random()*challengeList.length);
  currentQuiz=challengeList[idx];
  document.getElementById('quizQ').textContent=currentQuiz.q+' = ?';
  document.getElementById('quizInput').value='';
  document.getElementById('quizFeedback').textContent='';
}
document.getElementById('startQuiz').addEventListener('click',()=>{
  quizTime=parseInt(document.getElementById('quizDuration').value,10);
  quizScore=0; document.getElementById('quizScore').textContent=`Correct: ${quizScore}`;
  newQuizQuestion();
  clearInterval(quizTimerInt);
  quizTimerInt=setInterval(()=>{
    quizTime--; document.getElementById('quizTimer').textContent=`Time: ${quizTime}s`;
    if(quizTime<=0){ clearInterval(quizTimerInt); document.getElementById('quizQ').textContent='Time Up!'; }
  },1000);
});
document.getElementById('stopQuiz').addEventListener('click',()=>{ clearInterval(quizTimerInt); });
document.getElementById('quizCheck').addEventListener('click',()=>{
  const val=document.getElementById('quizInput').value.trim();
  const f=document.getElementById('quizFeedback');
  if(val.toLowerCase()===currentQuiz.a.toLowerCase()){ f.textContent='‚úÖ Correct!'; f.className='answer ok'; quizScore++; document.getElementById('quizScore').textContent=`Correct: ${quizScore}`; tone(880,0.06); csvData.push([currentQuiz.q,currentQuiz.a]); }
  else{ f.textContent=`‚ùå Wrong (Answer: ${currentQuiz.a})`; f.className='answer bad'; tone(220,0.06); csvData.push([currentQuiz.q,currentQuiz.a]); }
  newQuizQuestion();
});

// ===== CSV Download =====
document.getElementById('downloadCSVBtn').addEventListener('click',()=>{
  const csvContent=csvData.map(e=>e.join(',')).join('\n');
  const blob=new Blob([csvContent],{type:'text/csv'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='geometry_log.csv'; a.click();
  URL.revokeObjectURL(url);
});
</script>
</body>
</html>
